{% extends "hvacbase.html" %}
{% block content %}

<style>
#suppliers {
    border-collapse: collapse;
    width: 100%;
    align-content: left; 
}

#suppliers td, #suppliers th {
    border: 1px solid #ddd;
    padding: 10px;
}

#suppliers tr:{background-color: white}

#suppliers tr:hover {background-color: #ddd;}

#suppliers th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: lightsteelblue;
    color: black;
}

.bgimgs {

    background-image: url('https://www.mcstain.com/wp-content/uploads/2017/01/living-room-background-final.jpg');
    min-height: 100%;
    background-position: center;
    background-size: 100% 100% ;
    color: black;   
    
} 


input[type=text] {
    width: 150px;
    box-sizing: border-box;
    border: 2px solid #ccc;
    border-radius: 4px;
    font-size: medium;
    background-color:
     white;
    padding: 6px 6px;
    -webkit-transition: width 0.4s ease-in-out;
    transition: width 0.4s ease-in-out;
    text-align: left;
}

input[type=text]:focus {
    width: 60%;
}

.button {
  display: inline-block;
  padding: 6px 18px;
  cursor: pointer;
  text-align: center;
  color: white;
  background-color: lightsteelblue;
  border: 1px solid black;
  border-radius: 15px;
}


</style>

<body onload="createTableSup();">
<div class="bgimgs w3-display-container w3-animate-opacity w3-text-white" style="width:100%; height:100%;">
<div class="w3-main" style="margin-left:300px;">

  <header class="w3-container" style="padding-top:86px">
    <h5 style="color:black;text-align: center;"><b>Suppliers</b></h5>
  </header>

	<hr>

	<div class="w3-half w3-container" style="padding-top:13px; align-content: right;">
    <div class="container" style="width:80%; height:50%;">
    <div id="map" style="width:100%; height:100%;border: 1px solid black; color:black;"></div>

  </div>
</div>

  <div class="w3-half w3-container" style="padding-top:13px; align-content: left;">
    <div class="container" style="width:80%; height:50%;">
    <form onsubmit="return false;">
      <input type="text" name="search" style="color:black;" placeholder="Enter Component Name" id="comp_input" onkeyup="findSup(0,0);">
      <!-- <input type="submit" value="Search" class="button" style="color:black;"> -->
      <p id="match_suppliers" style="color:black"></p>
        
    </form>
<script>
        var map, infoWindow,count,marker,data;
        var locations = [], username_address = [], addresses=[], sups = [];
        function get_suppliers(){
          var poolDataDEAL = {
            UserPoolId : 'us-east-1_QFcNXf7g8', // Your user pool id here
            ClientId : '4ut1fjlf1v35jbj2v9cks6981l' // Your client id here
          };
           var url_name = "https://cl0igb14s8.execute-api.us-east-1.amazonaws.com/michael";
          // var url_name = "https://qvtsi28b2k.execute-api.us-east-1.amazonaws.com/kristen";
          //var url_name = "https://7srr0yyhjg.execute-api.us-east-1.amazonaws.com/jenny";
          var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolDataDEAL);
          var cognitoUser = userPool.getCurrentUser();

          if(cognitoUser !== null){
              cognitoUser.getSession(function(err, session) {
                  if(err){
                      alert(err);
                      return;
                  }

                  //console.log('session validity: ' + session.isValid());
                  //console.log(cognitoUser.username);

                  var request = new XMLHttpRequest();
                  request.open('GET', url_name + "/testdeal?vi=" + cognitoUser.username, false);  // `false` makes the request synchronous
                  request.send(null);

                  if (request.status === 200) {
                    //console.log(request.response);
                    data = request.response;
                    var tempInfo = JSON.parse(data)[0]; //save please
                    var comp = tempInfo.company;                    
                    //console.log(comp)
                    var request = new XMLHttpRequest();
                    request.open('GET', url_name + "/testdeal?s=" + comp, false);  // `false` makes the request synchronous
                    request.send(null);

                    if (request.status === 200) {
                      //console.log(request.response);
                      data = request.response;
                      var tempInfo = JSON.parse(data); //save please
                      for(var i = 0, size = tempInfo.length; i < size ; i++){
                        var item = tempInfo[i];
                        var l = item['location'].split(', ');
                        locations.push([item['companyname'],parseFloat(l[0]),parseFloat(l[1])]);
                        username_address.push([item['companyname'], item['address']]);
                        addresses.push([item['companyname'],item['address']]);
                        sups.push([item['companyname'], item['components']]);            
                      }
                      findSup(sups,1);
                    }
                  }
            });
          }
        }

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 35.397, lng: -95.644},
            zoom: 15
          });
          infoWindow = new google.maps.InfoWindow;

          get_suppliers();
          //console.log('hi');
          //console.log(locations);
          //console.log(username_address);

          // for (count=0; count<locations.length; count++) {
          //   marker= new google.maps.Marker({
          //     position: new google.maps.LatLng(locations[count][1], locations[count][2]), 
          //     map:map,
          //     title: locations[count][0]
          //   });
          
          // }
          var newcoords;
              function getLatLng(address){
    
              var parsedAddress = address.split(" ").join("+"); //parse address to fit into the url request
              var url = 'https://maps.googleapis.com/maps/api/geocode/json?address=' + parsedAddress + '&key=AIzaSyD-hKa4wnF8bY62DoUXjgeNr9oW-KDW2VU';
              var request = new XMLHttpRequest();
              request.open('GET', url, false);  // `false` makes the request synchronous
              request.send(null);

              if(request.status == 200){
                var newlat1 = JSON.parse(request.response).results[0].geometry.location.lat;//parses JSON file for coords
                    var newlng1 = JSON.parse(request.response).results[0].geometry.location.lng;
                    newcoords = { lat : newlat1, lng : newlng1};//finds new lat and lng
              }
            }

              var icon;
              for (count=0; count<addresses.length; count++) {
                var address = addresses[count];
                getLatLng(address[1]);

                var marker = new google.maps.Marker({
                    map: map,
                    position: newcoords,
                    title: address[0]
                    
                });

            
            }

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              infoWindow.setPosition(pos);
              infoWindow.setContent('Location found.');
              infoWindow.open(map);
              map.setCenter(pos);
            }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
          } else {
            handleLocationError(false, infoWindow, map.getCenter());
          }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }
      }

    var k;
    function findSup(info, first){
      document.getElementById("match_suppliers").innerHTML = "";
      if(first == 1){
        k = info;
        document.getElementById("match_suppliers").innerHTML = "first run";
      }
      else {
        var pass = document.getElementById("comp_input");
        for (count=0; count<k.length; count++){
          var i = k[count][1].toLowerCase().indexOf(pass.value.trim().toLowerCase());
          if(pass.value == ""){
            document.getElementById("match_suppliers").innerHTML = "";

          }
          else if(i > -1){
            var indexStart = k[count][1].toLowerCase().lastIndexOf(',', i);
            var indexEnd = k[count][1].toLowerCase().indexOf(',', i);
            
            if (indexEnd == -1)
              indexEnd = k[count][1].length + 1;

            var word = k[count][1].substring(indexStart+1, indexEnd)
            document.getElementById("match_suppliers").innerHTML = document.getElementById("match_suppliers").innerHTML + "<br>" + k[count][0] + " (" + word + ")";
          }
        }
      }
    }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-hKa4wnF8bY62DoUXjgeNr9oW-KDW2VU&callback=initMap">
    </script>
    <table id="suppliers">
      <tr style="background-color: lightsteelblue">
        <th>Name</th>
        <th>Address</th>
        <th>Phone Number</th>
        <th>Components</th>
      </tr>
    </table>
  </div>
</div>

</div>
</div>
<script src="{{ url_for('static', filename='appdeal.js') }}"></script>
{% for js_url in config.JS_INCLUDES %}
    <script src="{{ js_url }}"></script>
{% endfor %}
</body>


{% endblock %}