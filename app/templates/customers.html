{% extends "hvacbase.html" %}
{% block content %}

<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>


<style>
#customersT {
    border-collapse: collapse;
    width: 100%;
}

#customersT td, #customersT th {
    border: 1px solid black;
    padding: 10px;
}


#customersT tr:hover {background-color: grey;}

#customersT th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: lightsteelblue;
    color: black;

}

.bgimgc {

    background-image: url('https://www.mcstain.com/wp-content/uploads/2017/01/living-room-background-final.jpg');
    min-height: 100%;
    background-position: center;
    background-size: 100% 100% ;
    color: black;    

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}

/* The Close Button */
.close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;



}
</style>

<body onload="createTableCus();">

<div class="bgimgc w3-display-container w3-animate-opacity w3-text-white" style="width:100%; height:100%;">
  <div class="w3-main" style="margin-left:300px;">
    <header class="w3-container" style="padding-top:86px">
      <h5 style="color:black;text-align: center;"><b>Customers</b></h5>
    </header>
	  <hr>

	  <div class="w3-half w3-container" style="padding-top:10px;">
    <div class="container" style="width:80%; height:50%;">

    <div id="map" style="width:100%; height:100%;border: 1px solid black; color:black; text-align: center;"></div>
      <script>
        var map, infoWindow,count,marker,data,count;
        var locations = [];
        function get_customers(){
          var poolDataDEAL = {
            UserPoolId : 'us-east-1_QFcNXf7g8', // Your user pool id here
            ClientId : '4ut1fjlf1v35jbj2v9cks6981l' // Your client id here
          };
          // var url_name = "https://qvtsi28b2k.execute-api.us-east-1.amazonaws.com/kristen";
          var url_name = "https://7srr0yyhjg.execute-api.us-east-1.amazonaws.com/jenny";
          var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolDataDEAL);
          var cognitoUser = userPool.getCurrentUser();

          if(cognitoUser !== null){
              cognitoUser.getSession(function(err, session) {
                  if(err){
                      alert(err);
                      return;
                  }

                  console.log('session validity: ' + session.isValid());
                  console.log(cognitoUser.username);

                  var request = new XMLHttpRequest();
                  request.open('GET', url_name + "/testdeal?vi=" + cognitoUser.username, false);  // `false` makes the request synchronous
                  request.send(null);

                  if (request.status === 200) {
                    console.log(request.response);
                    var data = request.response;
                    var tempInfo = JSON.parse(data)[0]; //save please
                    var customers = tempInfo.customers.split(" ");        

                    for (var j = 0, size = customers.length; j < size ; j++) {
                      var cus = customers[j];
                      console.log(cus)
                      var request = new XMLHttpRequest();
                      request.open('GET', url_name + "/testdeal?ci=" + cus, false);  // `false` makes the request synchronous
                      request.send(null);

                      if (request.status === 200) {
                        console.log(request.response);
                        var data = request.response;
                        var tempInfo = JSON.parse(data); //save please
                        for(var i = 0, size = tempInfo.length; i < size ; i++){
                          var item = tempInfo[i];
                          var l = item['locations'].split(', ');
                          locations.push([item['given_name'] + " " + item['family_name'],parseFloat(l[0]),parseFloat(l[1]),item['unithealth']]);
                        }
                      }
                    }
                  }
            });
          }
        }

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 35.397, lng: -95.644},
          zoom: 15
          });
          infoWindow = new google.maps.InfoWindow;

          get_customers();
          console.log('hi');
          console.log(locations);

          var icon;
          for (count=0; count<locations.length; count++) {
            if (locations[count][3] == "GREEN"){
              icon = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            }
            else if (locations[count][3] == "RED"){
              icon = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
            }
            else {
              icon = 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
            }
           marker= new google.maps.Marker({
            position: new google.maps.LatLng(locations[count][1], locations[count][2]), 
            map:map,
            icon: icon,
            title: locations[count][0]
            });
          
          }
        }
          locationsg = [		
          				['1',29.970276, -95.435214],
          				['2',29.864250, -95.544214],
          				['3',29.736557, -95.467971],
          				['4',29.719679, -95.660597],
          				['5',29.636634, -95.444669],
          				['6',29.485177, -95.396787],
          				['7',29.595775, -95.222718],
          				['8',29.655681, -95.125609],
          				['9',29.760033, -95.211939],
          				['10',29.791824, -95.157195],
          				['11',29.820785, -95.035227],
          				['12',29.851412, -95.213873],
          				['13',29.872776, -95.293785],
          				['14',29.784867, -95.332280],
           				['15',29.778216, -95.357816],
           				['17',29.717611, -95.380881],
           				['18',30.021806, -95.513613],
           			];
          locationsy=[
           				['19',30.139947, -95.750629],
           				['21',29.502676, -95.911116],
           				['22',29.360796, -95.641705],
           				['23',29.503293, -95.159034],
           				['24',30.048370, -95.093205],
           				['25',29.657371, -95.062926],
           			];

          locationsr=[
  					      ['16',29.755637, -95.336662],
  					      ['20',29.881143, -95.959049],

           			];


          //green customers
        	for (count=0; count<locationsg.length; count++) {
        		marker= new google.maps.Marker({
        			position: new google.maps.LatLng(locationsg[count][1], locationsg[count][2]), 
        			map:map,
        			icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
        			title: locationsg[count][0]
        		});       	
            }
          //yellow customers
        	for (count=0; count<locationsy.length; count++) {
        		marker= new google.maps.Marker({
        			position: new google.maps.LatLng(locationsy[count][1], locationsy[count][2]), 
        			map:map,
        			icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
        			title: locationsy[count][0]
        		});          	
            }

        	for (count=0; count<locationsr.length; count++) {
        		marker= new google.maps.Marker({
        			position: new google.maps.LatLng(locationsr[count][1], locationsr[count][2]), 
        			map:map,
        			icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
        			title: locationsr[count][0]
        		});         	
            }    


          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
              };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            infoWindow.open(map);
            map.setCenter(pos);
            }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
            } 
          else {
            handleLocationError(false, infoWindow, map.getCenter());
          }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
          infoWindow.setPosition(pos);
          infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
          infoWindow.open(map);
          }
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-hKa4wnF8bY62DoUXjgeNr9oW-KDW2VU&callback=initMap">
      </script>
    </div>
  </div>
	<div class="w3-half w3-container" style="padding-top:10px; text-align: center">
    <div class="container" style="width:80%; height:50%;">
		<table id="customersT">
		  <tr style="background-color: lightsteelblue">
		    <th>Unit Status</th>
		    <th>Name</th>
        <th>Address</th>
		    <th>Email</th>
		    <th>Phone Number</th>
      </tr>
		</table>

</div>
</div>
<script src="{{ url_for('static', filename='appdeal.js') }}"></script>
{% for js_url in config.JS_INCLUDES %}
    <script src="{{ js_url }}"></script>
{% endfor %}
</body>
</html>


{% endblock %}